<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>人员管理 - FaceEye</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/style.css" />
    <style>
      .person-img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        border-bottom: 1px solid var(--glass-border);
      }
      .card-actions {
        padding: 1.25rem;
        background: rgba(0, 0, 0, 0.1);
      }
      #peopleList {
        min-height: 400px;
      }
    </style>
  </head>
  <body>
    <!-- Navbar at Very Top -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top shadow-sm">
      <div class="container">
        <a class="navbar-brand" href="/">FaceEye</a>
        <button
          class="navbar-toggler border-0"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="/">人员管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/history">识别历史</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/search">AI 检索</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container pb-5">
      <div class="py-4 animate-fade-in">
        <h2 class="fw-bold text-dark">成员库管理</h2>
      </div>

      <!-- Registration Section -->
      <div
        class="row justify-content-center mb-5 animate-fade-in"
        style="animation-delay: 0.2s"
      >
        <div class="col-lg-8">
          <div class="glass-panel p-4 p-md-5">
            <h3 class="mb-4 text-dark fw-bold">注册新人员</h3>
            <form id="addForm" class="row g-4">
              <div class="col-md-5">
                <label class="form-label small text-muted fw-bold mb-2"
                  >姓名</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="uName"
                  placeholder="输入人员姓名..."
                  required
                />
              </div>
              <div class="col-md-5">
                <label class="form-label small text-muted fw-bold mb-2"
                  >照片</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="uFile"
                  accept="image/*"
                  required
                />
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100 py-3">
                  上传
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- People Grid -->
      <div
        class="row g-4 animate-fade-in"
        id="peopleList"
        style="animation-delay: 0.4s"
      >
        <!-- Loader -->
        <div class="col-12 text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="renameModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel border-0">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title text-dark fw-bold">重命名人员</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body py-4">
            <input type="hidden" id="oldName" />
            <div class="mb-0">
              <label class="form-label small text-muted fw-bold">新姓名</label>
              <input type="text" class="form-control" id="newName" />
            </div>
          </div>
          <div class="modal-footer border-0 pt-0">
            <button
              type="button"
              class="btn btn-outline-secondary border-0"
              data-bs-dismiss="modal"
            >
              取消
            </button>
            <button
              type="button"
              class="btn btn-primary shadow-sm"
              onclick="confirmRename()"
            >
              保存修改
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = "/api";

      async function loadPeople() {
        const res = await fetch(`${API_BASE}/faces`);
        const data = await res.json();
        const container = document.getElementById("peopleList");
        container.innerHTML = "";

        if (data.length === 0) {
          container.innerHTML =
            '<div class="col-12 text-center py-5"><p class="text-muted">库中暂无人员数据，请先上传注册。</p></div>';
          return;
        }

        data.forEach((p, index) => {
          const delay = (index % 12) * 0.05;
          const card = `
                <div class="col-xl-3 col-lg-4 col-sm-6 animate-fade-in" style="animation-delay: ${delay}s">
                    <div class="card h-100">
                        <img src="${p.image_url}" class="person-img" alt="${p.name}">
                        <div class="card-body text-center py-3">
                            <h5 class="card-title mb-0">${p.name}</h5>
                            <p class="small text-muted mb-0">已注册</p>
                        </div>
                        <div class="card-actions d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="openRename('${p.name}')">重命名</button>
                            <button class="btn btn-sm btn-link text-danger p-0 px-2 border-0" onclick="deletePerson('${p.name}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                  <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
          container.innerHTML += card;
        });
      }

      // Add Person
      document
        .getElementById("addForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = e.target.querySelector('button[type="submit"]');
          const originalText = btn.textContent;
          btn.textContent = "上传中...";
          btn.disabled = true;

          const formData = new FormData();
          formData.append("name", document.getElementById("uName").value);
          formData.append("file", document.getElementById("uFile").files[0]);

          try {
            const res = await fetch("/upload/", {
              method: "POST",
              body: formData,
            });
            const result = await res.json();
            if (res.ok) {
              document.getElementById("addForm").reset();
              loadPeople();
            } else {
              alert("错误: " + (result.detail || "上传失败"));
            }
          } catch (err) {
            alert("错误: 连接失败或服务器错误");
          } finally {
            btn.textContent = originalText;
            btn.disabled = false;
          }
        });

      // Delete Person
      async function deletePerson(name) {
        if (!confirm(`确定要彻底删除 ${name} 的注册信息吗？`)) return;
        try {
          const res = await fetch(`${API_BASE}/faces/${name}`, {
            method: "DELETE",
          });
          if (res.ok) loadPeople();
          else alert("删除失败");
        } catch (err) {
          console.error(err);
        }
      }

      // Rename Person
      const renameModal = new bootstrap.Modal(
        document.getElementById("renameModal"),
      );
      function openRename(name) {
        document.getElementById("oldName").value = name;
        document.getElementById("newName").value = name;
        renameModal.show();
      }

      async function confirmRename() {
        const oldName = document.getElementById("oldName").value;
        const newName = document.getElementById("newName").value;
        if (!newName || newName === oldName) return;

        try {
          const res = await fetch(`${API_BASE}/faces/${oldName}/${newName}`, {
            method: "PUT",
          });
          if (res.ok) {
            renameModal.hide();
            loadPeople();
          } else {
            alert("重命名失败（名称可能已存在）");
          }
        } catch (err) {
          console.error(err);
        }
      }

      // Initial Load
      loadPeople();
    </script>
  </body>
</html>
