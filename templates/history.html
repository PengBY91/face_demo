<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>识别历史 - 人脸识别系统</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #4a90e2;
        --bg-color: #f4f7f6;
      }
      body {
        background-color: var(--bg-color);
        font-family:
          "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Segoe UI",
          Tahoma, Geneva, Verdana, sans-serif;
      }
      .navbar {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }
      .history-card {
        transition: transform 0.2s;
        border: none;
        border-radius: 12px;
        overflow: hidden;
      }
      .history-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .history-img {
        height: 180px;
        object-fit: cover;
      }
      .filter-panel {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">FaceEye</a>
        <div class="navbar-nav">
          <a class="nav-link" href="/">人员管理</a>
          <a class="nav-link active" href="/history">识别历史</a>
          <a class="nav-link" href="/search">AI 检索</a>
        </div>
      </div>
    </nav>

    <div class="container py-5">
      <h2 class="mb-4">识别历史记录</h2>

      <!-- Filters -->
      <div class="filter-panel">
        <form id="filterForm" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">姓名</label>
            <input
              type="text"
              class="form-control"
              id="filterName"
              placeholder="搜索姓名..."
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">开始时间</label>
            <input
              type="datetime-local"
              class="form-control"
              id="filterStart"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">结束时间</label>
            <input type="datetime-local" class="form-control" id="filterEnd" />
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
              应用筛选
            </button>
          </div>
        </form>
      </div>

      <!-- History List -->
      <div class="row g-4" id="historyList">
        <!-- Cards will be injected here -->
      </div>

      <div class="text-center mt-5" id="loading" style="display: none">
        <div class="spinner-border text-primary" role="status"></div>
      </div>
    </div>

    <script>
      async function loadHistory() {
        const name = document.getElementById("filterName").value;
        const start = document.getElementById("filterStart").value;
        const end = document.getElementById("filterEnd").value;

        let url = `/api/history?limit=40`;
        if (name) url += `&name=${encodeURIComponent(name)}`;
        if (start) url += `&start_time=${start.replace("T", " ")}`;
        if (end) url += `&end_time=${end.replace("T", " ")}`;

        document.getElementById("loading").style.display = "block";
        try {
          const res = await fetch(url);
          const data = await res.json();
          const container = document.getElementById("historyList");
          container.innerHTML = "";

          data.forEach((item) => {
            const card = `
                        <div class="col-md-3 col-sm-6">
                            <div class="card history-card h-100 shadow-sm">
                                <img src="${item.image_url}" class="card-img-top history-img" alt="${item.person_name}">
                                <div class="card-body">
                                    <h5 class="card-title mb-1">${item.person_name}</h5>
                                    <p class="card-text text-muted small mb-0">相似度: ${(item.confidence * 100).toFixed(1)}%</p>
                                    <p class="card-text text-muted small">${item.timestamp}</p>
                                </div>
                            </div>
                        </div>
                    `;
            container.innerHTML += card;
          });

          if (data.length === 0) {
            container.innerHTML =
              '<div class="col-12 text-center py-5"><p class="text-muted">没有找到匹配的记录。</p></div>';
          }
        } catch (err) {
          console.error(err);
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      document.getElementById("filterForm").addEventListener("submit", (e) => {
        e.preventDefault();
        loadHistory();
      });

      // Initial load
      loadHistory();
    </script>
  </body>
</html>
